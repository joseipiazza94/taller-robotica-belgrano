---
const levels = [
  { 
    id: 'spark', 
    nombre: 'Spark Squad', 
    descripcion: 'Nivel Inicial: Exploración mecánica y lógica de bloques.',
    video: '/videos/nivel1.mp4', 
    detalleExtra: 'En este nivel los chicos trabajan con LEGO Education y conceptos básicos de física. Aprenden a dar sus primeros pasos en la lógica de programación mediante bloques visuales.',
    items: ['LEGO Education', 'Motores DC', 'Lógica'] 
  },
  { 
    id: 'circuit', 
    nombre: 'Circuit Masters', 
    descripcion: 'Nivel Intermedio: Electrónica aplicada e impresión 3D.',
    video: '/videos/nivel2.mp4', 
    detalleExtra: 'Pasamos al hardware real. Introducción a Arduino, sensores ultrasónicos y modelado técnico para impresión 3D en nuestras Bambu Lab A1.',
    items: ['Arduino', 'Modelado 3D', 'Sensores'] 
  },
  { 
    id: 'cyber', 
    nombre: 'Cyber Builders', 
    descripcion: 'Nivel Avanzado: Robótica de competencia y código real.',
    video: '/videos/nivel3.mp4', 
    detalleExtra: 'El nivel de alto rendimiento. Preparación para la WRO, programación avanzada en Python/C++ y diseño de robots autónomos de competición.',
    items: ['WRO', 'Python/C++', 'Sensores Pro'] 
  }
];
---

<section class="niveles-wrapper" id="nivelesWrapper">
  <div class="vertical-title"><span>NIVELES</span></div>

  <div class="niveles-container" id="levelsContainer">
    {levels.map((level) => (
      <div class="level-bar" data-id={level.id}>
        <div class="level-content">
          
          {/* VISTA CERRADA: Ahora con Position Absolute para evitar el parpadeo */}
          <div class="main-info">
            <div class="text-area">
              <h3>{level.nombre}</h3>
              <p>{level.descripcion}</p>
              <div class="pills">
                {level.items.map(item => <span>{item}</span>)}
              </div>
            </div>
            <div class="horizontal-video">
              <video muted loop playsinline preload="metadata">
                <source src={level.video} type="video/mp4" />
              </video>
            </div>
          </div>

          {/* VISTA EXPANDIDA */}
          <div class="expanded-info">
            <div class="expanded-layout">
              <div class="expanded-text">
                <button class="btn-close-level">← VOLVER</button>
                <h4>Objetivos del Nivel</h4>
                <p>{level.detalleExtra}</p>
                <div class="content-placeholder">
                  <p>[ CONTENIDO CURRICULAR / FOTOS ]</p>
                </div>
              </div>
              <div class="vertical-video">
                <video muted loop playsinline preload="metadata">
                  <source src={level.video} type="video/mp4" />
                </video>
              </div>
            </div>
          </div>
        </div>
      </div>
    ))}
  </div>
</section>

<style>
  .niveles-wrapper {
    position: relative;
    background: #121212;
    padding: 6rem 0; 
    min-height: auto;
    display: flex;
    align-items: center;
    overflow: hidden;
  }

  .niveles-container {
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
    width: 100%;
    transition: all 0.6s cubic-bezier(0.85, 0, 0.15, 1);
    align-items: flex-start; 
  }

  .level-bar {
    background: #8b1d20;
    width: 75vw;
    height: 240px;
    transition: all 0.7s cubic-bezier(0.85, 0, 0.15, 1);
    cursor: pointer;
    overflow: hidden;
    position: relative;
    z-index: 5;
  }

  .level-bar:not(.is-expanded):hover {
    width: 82vw;
    background: #d83135;
  }

  .level-bar.is-expanded {
    height: 72vh;
    width: 78vw;
    background: #1e1e1e;
    cursor: default;
    z-index: 10;
    margin-left: 6vw;
    box-shadow: 0 0 50px rgba(0,0,0,0.6);
  }

  .niveles-container.has-expanded .level-bar:not(.is-expanded) {
    height: 0;
    opacity: 0;
    margin: 0;
    pointer-events: none;
  }

  .level-content { position: relative; height: 100%; width: 100%; }

  /* VISTA CERRADA (AJUSTADA PARA EL ZERO-FLICKER) */
  .main-info {
    display: flex;
    width: 100%;
    height: 240px;
    align-items: center;
    justify-content: space-between;
    padding-left: 4rem;
    transition: opacity 0.5s ease, visibility 0.5s ease;
    position: absolute;
    top: 0;
    left: 0;
    z-index: 1;
  }

  .level-bar.is-expanded .main-info { 
    opacity: 0; 
    visibility: hidden;
    pointer-events: none;
  }

  .horizontal-video { width: 400px; height: 240px; background: #000; }

  /* VISTA EXPANDIDA */
  .expanded-info { 
    position: relative;
    z-index: 2;
    opacity: 0; 
    visibility: hidden; 
    height: 100%;
    transition: opacity 0.5s ease; 
  }

  .level-bar.is-expanded .expanded-info { 
    opacity: 1; 
    visibility: visible; 
  }

  .expanded-layout { display: grid; grid-template-columns: 1fr 320px; height: 100%; }

  .expanded-text { padding: 3rem 4rem; color: white; display: flex; flex-direction: column; overflow-y: auto; }

  .btn-close-level {
    align-self: flex-start;
    background: #d83135;
    color: white;
    border: none;
    padding: 0.7rem 1.4rem;
    font-weight: 900;
    cursor: pointer;
    margin-bottom: 2rem;
    text-transform: uppercase;
    font-size: 0.8rem;
  }

  .text-area h3 { font-size: 2rem; font-weight: 900; text-transform: uppercase; margin: 0; color: white; }
  .text-area p { color: rgba(255,255,255,0.8); margin: 5px 0 15px; }

  .pills { display: flex; gap: 0.5rem; }
  .pills span { background: rgba(0,0,0,0.3); padding: 4px 12px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; border: 1px solid rgba(255,255,255,0.1); }

  .vertical-video { width: 100%; height: 100%; background: #000; }

  video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    filter: grayscale(100%) brightness(0.4);
    transition: filter 0.5s ease;
  }

  .level-bar:hover video, .level-bar.is-expanded video { filter: grayscale(0%) brightness(1); }

  .vertical-title { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); z-index: 0; }
  .vertical-title span { writing-mode: vertical-rl; font-size: 7rem; font-weight: 900; color: rgba(255,255,255,0.03); text-transform: uppercase; }

  @media (max-width: 1024px) {
    .level-bar { width: 100vw; }
    .main-info { padding-left: 1.5rem; flex-direction: column; height: auto; position: relative; }
    .horizontal-video { width: 100%; height: 200px; }
    .expanded-layout { grid-template-columns: 1fr; }
    .vertical-video { height: 250px; order: -1; }
  }
</style>

<script>
  const setupLevels = () => {
    const container = document.getElementById('levelsContainer');
    const bars = document.querySelectorAll('.level-bar');

    bars.forEach(bar => {
      const horizontalVideo = bar.querySelector('.horizontal-video video') as HTMLVideoElement;
      const verticalVideo = bar.querySelector('.vertical-video video') as HTMLVideoElement;
      
      const syncAndPlay = (from: HTMLVideoElement, to: HTMLVideoElement) => {
        to.currentTime = from.currentTime;
        to.play().catch(()=>{});
      };

      bar.addEventListener('mouseenter', () => {
        if (!bar.classList.contains('is-expanded')) horizontalVideo.play().catch(()=>{});
      });

      bar.addEventListener('mouseleave', () => {
        if (!bar.classList.contains('is-expanded')) {
          horizontalVideo.pause();
          horizontalVideo.currentTime = 0;
        }
      });

      bar.addEventListener('click', (e) => {
        const target = e.target as HTMLElement;
        
        if (target.classList.contains('btn-close-level')) {
          syncAndPlay(verticalVideo, horizontalVideo);
          bar.classList.remove('is-expanded');
          container?.classList.remove('has-expanded');
          
          setTimeout(() => {
            verticalVideo.pause();
            if (!bar.matches(':hover')) {
               horizontalVideo.pause();
               horizontalVideo.currentTime = 0;
            }
          }, 700);
          e.stopPropagation();
          return;
        }

        if (!bar.classList.contains('is-expanded')) {
          syncAndPlay(horizontalVideo, verticalVideo);
          bars.forEach(b => b.classList.remove('is-expanded'));
          bar.classList.add('is-expanded');
          container?.classList.add('has-expanded');
        }
      });
    });
  };

  setupLevels();
  document.addEventListener('astro:page-load', setupLevels);
</script>